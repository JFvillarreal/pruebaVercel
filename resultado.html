<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Administrativo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .card {
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 30px;
    }
    .filter-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .teacher-card {
      transition: all 0.3s ease;
    }
    .teacher-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <h1 class="mt-4">Dashboard Administrativo</h1>
        <p class="lead">Evaluaciones del cuerpo docente</p>
      </div>
    </div>

    <!-- Filtros -->
    <div class="row filter-container">
      <div class="col-md-4">
        <label for="select-docente" class="form-label">Seleccionar Docente:</label>
        <select id="select-docente" class="form-select">
          <option value="all">Todos los docentes</option>
          <!-- Opciones se llenarán dinámicamente -->
        </select>
      </div>
      <div class="col-md-4">
        <label for="select-semestre" class="form-label">Seleccionar Semestre:</label>
        <select id="select-semestre" class="form-select">
          <option value="all">Todos los semestres</option>
          <!-- Opciones se llenarán dinámicamente -->
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button id="btn-aplicar-filtros" class="btn btn-primary w-100">Aplicar Filtros</button>
      </div>
    </div>

    <!-- Resumen General -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Resumen General</h5>
            <span id="resumen-filtros" class="badge bg-info">Mostrando: Todos los docentes - Todos los semestres</span>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 text-center">
                <h3 id="total-evaluaciones">0</h3>
                <p class="text-muted">Evaluaciones</p>
              </div>
              <div class="col-md-3 text-center">
                <h3 id="promedio-global">0.00</h3>
                <p class="text-muted">Promedio Global</p>
              </div>
              <div class="col-md-3 text-center">
                <h3 id="docentes-evaluados">0</h3>
                <p class="text-muted">Docentes Evaluados</p>
              </div>
              <div class="col-md-3 text-center">
                <h3 id="asignaturas-evaluadas">0</h3>
                <p class="text-muted">Asignaturas</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráficos principales -->
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Distribución de Evaluaciones</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="chart-distribucion"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Top 5 Mejores Docentes</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="chart-top-docentes"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Evolución por semestre -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5>Evolución por Semestre</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="chart-evolucion"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Listado de docentes -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5>Resultados por Docente</h5>
          </div>
          <div class="card-body">
            <div id="lista-docentes" class="row">
              <!-- Se llenará dinámicamente -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comentarios -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5>Comentarios Destacados</h5>
          </div>
          <div class="card-body">
            <div id="comentarios-destacados">
              <!-- Se llenará dinámicamente -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabase = createClient(
      'https://crwjvwwaksvdnryjmzvl.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyd2p2d3dha3N2ZG5yeWptenZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3NDY3ODksImV4cCI6MjA2MDMyMjc4OX0.s08kYWtmpc9c2b9VGwcKuiEna48KGoK2vz4y8rafyrE'
    );

    // Variables globales
    let allEvaluaciones = [];
    let allDocentes = [];
    let allSemestres = [];
    let currentFilters = {
      docente: 'all',
      semestre: 'all'
    };

    // Cargar todos los datos iniciales
async function cargarDatosIniciales() {
  try {
    // 1. Cargar todos los docentes (consulta corregida)
    const { data: docentes, error: errorDocentes } = await supabase
      .from('User')
      .select('id, firstname, lastname')
      .or('role.eq.docente,role.eq.Docente') // Filtro mejorado para roles
      .order('lastName', { ascending: true });

    if (errorDocentes) {
      console.error('Error cargando docentes:', errorDocentes);
      throw errorDocentes;
    }
    
    allDocentes = docentes || [];
    llenarSelectDocentes();

    // 2. Cargar todas las evaluaciones (consulta optimizada)
    const { data: evaluaciones, error: errorEvaluaciones } = await supabase
      .from('answer')
      .select(`
        *,
        User:docente_id (firstname, lastname),
        Asignatura:asignatura_id (nombre)
      `);

    if (errorEvaluaciones) {
      console.error('Error cargando evaluaciones:', errorEvaluaciones);
      throw errorEvaluaciones;
    }
    
    allEvaluaciones = evaluaciones || [];

    // 3. Extraer semestres únicos
    allSemestres = [...new Set(allEvaluaciones.map(e => e.semestre))]
      .sort((a, b) => b.localeCompare(a)); // Orden descendente

    llenarSelectSemestres();
    aplicarFiltros();

  } catch (error) {
    console.error('Error completo:', {
      message: error.message,
      details: error.details,
      code: error.code,
      hint: error.hint
    });
    
    // Mostrar error amigable
    const errorContainer = document.createElement('div');
    errorContainer.className = 'alert alert-danger';
    errorContainer.innerHTML = `
      <h4>Error al cargar los datos</h4>
      <p>${error.message || 'Por favor verifica la conexión e intenta nuevamente.'}</p>
      <small>Código: ${error.code || 'N/A'}</small>
    `;
    
    document.querySelector('.container-fluid').prepend(errorContainer);
  }
}

    // Llenar select de docentes
    function llenarSelectDocentes() {
      const select = document.getElementById('select-docente');
      select.innerHTML = '<option value="all">Todos los docentes</option>';
      
      allDocentes.forEach(docente => {
        const option = document.createElement('option');
        option.value = docente.id;
        option.textContent = `${docente.lastname}, ${docente.firstname}`;
        select.appendChild(option);
      });
    }

    // Llenar select de semestres
    function llenarSelectSemestres() {
      const select = document.getElementById('select-semestre');
      select.innerHTML = '<option value="all">Todos los semestres</option>';
      
      allSemestres.forEach(semestre => {
        const option = document.createElement('option');
        option.value = semestre;
        option.textContent = semestre;
        select.appendChild(option);
      });
    }

    // Aplicar filtros y actualizar vistas
    function aplicarFiltros() {
      // Obtener valores de los filtros
      currentFilters = {
        docente: document.getElementById('select-docente').value,
        semestre: document.getElementById('select-semestre').value
      };

      // Filtrar evaluaciones
      let evaluacionesFiltradas = [...allEvaluaciones];
      
      if (currentFilters.docente !== 'all') {
        evaluacionesFiltradas = evaluacionesFiltradas.filter(e => e.docente_id == currentFilters.docente);
      }
      
      if (currentFilters.semestre !== 'all') {
        evaluacionesFiltradas = evaluacionesFiltradas.filter(e => e.semestre === currentFilters.semestre);
      }

      // Actualizar resumen de filtros
      const docenteText = currentFilters.docente === 'all' 
        ? 'Todos los docentes' 
        : allDocentes.find(d => d.id == currentFilters.docente)?.lastName || 'Docente';
      
      const semestreText = currentFilters.semestre === 'all' 
        ? 'Todos los semestres' 
        : currentFilters.semestre;
      
      document.getElementById('resumen-filtros').textContent = 
        `Mostrando: ${docenteText} - ${semestreText}`;

      // Procesar datos filtrados
      procesarDatosFiltrados(evaluacionesFiltradas);
    }

    // Procesar datos con filtros aplicados
    function procesarDatosFiltrados(evaluaciones) {
      // 1. Actualizar resumen general
      actualizarResumenGeneral(evaluaciones);
      
      // 2. Generar gráficos
      generarGraficoDistribucion(evaluaciones);
      generarGraficoTopDocentes(evaluaciones);
      generarGraficoEvolucion(evaluaciones);
      
      // 3. Actualizar listado de docentes
      actualizarListadoDocentes(evaluaciones);
      
      // 4. Mostrar comentarios destacados
      mostrarComentariosDestacados(evaluaciones);
    }

    // Actualizar resumen general
    function actualizarResumenGeneral(evaluaciones) {
      const totalEvaluaciones = evaluaciones.length;
      
      // Calcular promedio global
      let sumaTotal = 0;
      evaluaciones.forEach(ev => {
        for (let i = 1; i <= 12; i++) {
          sumaTotal += ev[`q${i}`];
        }
      });
      const promedioGlobal = (sumaTotal / (totalEvaluaciones * 12)).toFixed(2);
      
      // Contar docentes y asignaturas únicas
      const docentesUnicos = new Set(evaluaciones.map(e => e.docente_id));
      const asignaturasUnicas = new Set(evaluaciones.map(e => e.asignatura_id));
      
      // Actualizar UI
      document.getElementById('total-evaluaciones').textContent = totalEvaluaciones;
      document.getElementById('promedio-global').textContent = promedioGlobal;
      document.getElementById('docentes-evaluados').textContent = docentesUnicos.size;
      document.getElementById('asignaturas-evaluadas').textContent = asignaturasUnicas.size;
    }

    // Generar gráfico de distribución
    function generarGraficoDistribucion(evaluaciones) {
      const ctx = document.getElementById('chart-distribucion').getContext('2d');
      
      // Destruir gráfico anterior si existe
      if (window.distribucionChart) {
        window.distribucionChart.destroy();
      }
      
      // Calcular distribución
      const distribucion = [0, 0, 0, 0, 0]; // Para puntajes 1-5
      evaluaciones.forEach(ev => {
        for (let i = 1; i <= 12; i++) {
          const puntaje = ev[`q${i}`] - 1; // Convertir 1-5 a 0-4 para el array
          distribucion[puntaje]++;
        }
      });
      
      window.distribucionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['1 (Bajo)', '2', '3', '4', '5 (Alto)'],
          datasets: [{
            label: 'Cantidad de respuestas',
            data: distribucion,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Número de respuestas'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Puntuación'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.raw} respuestas`;
                }
              }
            }
          }
        }
      });
    }

    // Generar gráfico de top docentes
    function generarGraficoTopDocentes(evaluaciones) {
      const ctx = document.getElementById('chart-top-docentes').getContext('2d');
      
      // Destruir gráfico anterior si existe
      if (window.topDocentesChart) {
        window.topDocentesChart.destroy();
      }
      
      // Calcular promedios por docente (solo si estamos viendo todos los docentes)
      if (currentFilters.docente !== 'all' || evaluaciones.length === 0) {
        document.getElementById('chart-top-docentes').style.display = 'none';
        return;
      }
      
      document.getElementById('chart-top-docentes').style.display = 'block';
      
      const promediosDocentes = {};
      evaluaciones.forEach(ev => {
        if (!promediosDocentes[ev.docente_id]) {
          promediosDocentes[ev.docente_id] = {
            suma: 0,
            count: 0,
            nombre: `${ev.User?.lastname}, ${ev.User?.firstname}`
          };
        }
        
        for (let i = 1; i <= 12; i++) {
          promediosDocentes[ev.docente_id].suma += ev[`q${i}`];
          promediosDocentes[ev.docente_id].count++;
        }
      });
      
      // Convertir a array y calcular promedios
      const docentesArray = Object.entries(promediosDocentes).map(([id, data]) => ({
        id,
        nombre: data.nombre,
        promedio: data.suma / data.count
      }));
      
      // Ordenar y tomar top 5
      const topDocentes = docentesArray
        .sort((a, b) => b.promedio - a.promedio)
        .slice(0, 5);
      
      window.topDocentesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topDocentes.map(d => d.nombre),
          datasets: [{
            label: 'Promedio de evaluación',
            data: topDocentes.map(d => d.promedio),
            backgroundColor: 'rgba(75, 192, 192, 0.7)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          scales: {
            x: {
              beginAtZero: false,
              min: 1,
              max: 5,
              title: {
                display: true,
                text: 'Promedio (1-5)'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Promedio: ${context.raw.toFixed(2)}`;
                }
              }
            }
          }
        }
      });
    }

    // Generar gráfico de evolución
    function generarGraficoEvolucion(evaluaciones) {
      const ctx = document.getElementById('chart-evolucion').getContext('2d');
      
      // Destruir gráfico anterior si existe
      if (window.evolucionChart) {
        window.evolucionChart.destroy();
      }
      
      // Agrupar por semestre
      const datosPorSemestre = {};
      evaluaciones.forEach(ev => {
        if (!datosPorSemestre[ev.semestre]) {
          datosPorSemestre[ev.semestre] = [];
        }
        
        let suma = 0;
        for (let i = 1; i <= 12; i++) {
          suma += ev[`q${i}`];
        }
        datosPorSemestre[ev.semestre].push(suma / 12);
      });
      
      // Calcular promedios por semestre
      const semestresOrdenados = Object.keys(datosPorSemestre).sort();
      const promedios = semestresOrdenados.map(sem => {
        const datos = datosPorSemestre[sem];
        return datos.reduce((a, b) => a + b, 0) / datos.length;
      });
      
      window.evolucionChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: semestresOrdenados,
          datasets: [{
            label: 'Promedio por semestre',
            data: promedios,
            borderColor: 'rgba(153, 102, 255, 1)',
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: false,
              min: 1,
              max: 5,
              title: {
                display: true,
                text: 'Promedio'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Semestre'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Promedio: ${context.raw.toFixed(2)}`;
                }
              }
            }
          }
        }
      });
    }

    // Actualizar listado de docentes
    function actualizarListadoDocentes(evaluaciones) {
      const container = document.getElementById('lista-docentes');
      container.innerHTML = '';
      
      // Si estamos viendo un docente específico, no mostrar el listado
      if (currentFilters.docente !== 'all') {
        container.innerHTML = '<p>Mostrando resultados para el docente seleccionado.</p>';
        return;
      }
      
      // Agrupar evaluaciones por docente
      const docentesMap = new Map();
      
      evaluaciones.forEach(ev => {
        if (!docentesMap.has(ev.docente_id)) {
          docentesMap.set(ev.docente_id, {
            id: ev.docente_id,
            nombre: `${ev.User?.lastname}, ${ev.User?.firstname}`,
            evaluaciones: [],
            asignaturas: new Set()
          });
        }
        
        const docenteData = docentesMap.get(ev.docente_id);
        docenteData.evaluaciones.push(ev);
        docenteData.asignaturas.add(ev.Asignatura?.nombre);
      });
      
      // Calcular promedios y crear cards
      docentesMap.forEach(docenteData => {
        let sumaTotal = 0;
        let countTotal = 0;
        
        docenteData.evaluaciones.forEach(ev => {
          for (let i = 1; i <= 12; i++) {
            sumaTotal += ev[`q${i}`];
            countTotal++;
          }
        });
        
        const promedio = (sumaTotal / countTotal).toFixed(2);
        const evaluacionesCount = docenteData.evaluaciones.length;
        const asignaturasCount = docenteData.asignaturas.size;
        
        // Crear card
        const card = document.createElement('div');
        card.className = 'col-md-4 mb-4';
        card.innerHTML = `
          <div class="card teacher-card h-100">
            <div class="card-body">
              <h5 class="card-title">${docenteData.nombre}</h5>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="display-6">${promedio}</span>
                <span class="badge rounded-pill bg-${getRatingColor(promedio)}">
                  ${getRatingText(promedio)}
                </span>
              </div>
              <p class="card-text">
                <small class="text-muted">
                  ${evaluacionesCount} evaluaciones<br>
                  ${asignaturasCount} asignaturas
                </small>
              </p>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-${getRatingColor(promedio)}" 
                  role="progressbar" 
                  style="width: ${(promedio / 5) * 100}%" 
                  aria-valuenow="${promedio}" 
                  aria-valuemin="1" 
                  aria-valuemax="5">
                </div>
              </div>
            </div>
            <div class="card-footer bg-transparent">
              <a href="#" class="btn btn-sm btn-outline-primary ver-detalle" 
                data-docente-id="${docenteData.id}">
                Ver detalle
              </a>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
      
      // Si no hay docentes
      if (docentesMap.size === 0) {
        container.innerHTML = '<p>No hay datos disponibles con los filtros actuales.</p>';
      }
    }

    // Mostrar comentarios destacados
    function mostrarComentariosDestacados(evaluaciones) {
      const container = document.getElementById('comentarios-destacados');
      
      // Filtrar comentarios no vacíos
      const comentarios = evaluaciones
        .filter(ev => ev.comentarios && ev.comentarios.trim() !== '')
        .map(ev => ({
          texto: ev.comentarios,
          semestre: ev.semestre,
          docente: `${ev.User?.lastname}, ${ev.User?.firstname}`,
          asignatura: ev.Asignatura?.nombre
        }));
      
      // Mostrar máximo 5 comentarios
      if (comentarios.length === 0) {
        container.innerHTML = '<p>No hay comentarios disponibles con los filtros actuales.</p>';
        return;
      }
      
      let html = '<div class="list-group">';
      comentarios.slice(0, 5).forEach(com => {
        html += `
          <div class="list-group-item">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">${com.asignatura || 'Asignatura no especificada'}</h6>
              <small>${com.semestre}</small>
            </div>
            <p class="mb-1">${com.texto}</p>
            <small>${com.docente || 'Docente no especificado'}</small>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }

    // Helper functions
    function getRatingColor(promedio) {
      if (promedio >= 4.5) return 'success';
      if (promedio >= 3.5) return 'primary';
      if (promedio >= 2.5) return 'warning';
      return 'danger';
    }

    function getRatingText(promedio) {
      if (promedio >= 4.5) return 'Excelente';
      if (promedio >= 3.5) return 'Bueno';
      if (promedio >= 2.5) return 'Regular';
      return 'Necesita mejora';
    }

    // Event listeners
    document.getElementById('btn-aplicar-filtros').addEventListener('click', aplicarFiltros);

    // Inicializar
    document.addEventListener('DOMContentLoaded', cargarDatosIniciales);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>