<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Evaluación Docente</title>
  <link rel="stylesheet" href="css/cuestionario.css">
  <!-- Mover el script de Supabase al head con defer -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
</head>
<body>
  <div class="header">
    <div class="title">
      <h1>Universidad El Bosque</h1>
      <h2>Evaluación docente</h2>
    </div>
    <img src="/img/logoUEB.png" alt="Logo Universidad El Bosque" class="logo">
  </div>

  <form id="form-cuestionario" class="container">
    <h3>Cuestionario de Evaluación Docente</h3>
    
    <!-- Selección de docente -->
    <div class="question">
      <p>Seleccione el docente evaluado:</p>
      <select id="docente" name="docente" required>
        <option value="">-- Cargando docentes --</option>
      </select>
    </div>
    
    <!-- Contenedor de preguntas -->
    <div id="preguntas-container">
      <p>Cargando preguntas...</p>
    </div>
    
    <div class="question">
      <p>Comentarios adicionales (opcional):</p>
      <textarea name="comentarios" rows="4" placeholder="Escriba sus observaciones aquí..."></textarea>
    </div>
    
    <div class="navigation-buttons">
      <button type="submit" id="submit-btn" disabled>Enviar</button>
    </div>
  </form>

  <!-- Script principal con defer -->
  <script defer>
    // Esperar a que todo esté cargado
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // 1. Inicializar Supabase
        const supabaseUrl = 'https://crwjvwwaksvdnryjmzvl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyd2p2d3dha3N2ZG5yeWptenZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3NDY3ODksImV4cCI6MjA2MDMyMjc4OX0.s08kYWtmpc9c2b9VGwcKuiEna48KGoK2vz4y8rafyrE';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // 2. Obtener usuario logueado
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        if (userError || !user) {
          window.location.href = 'index.html';
          return;
        }
        const userId = user.id;

        // 3. Cargar docentes y preguntas en paralelo
        const [teachers, questions] = await Promise.all([
          loadTeachers(supabaseClient),
          loadQuestions(supabaseClient)
        ]);

        // 4. Renderizar interfaz
        renderTeachers(teachers);
        renderQuestions(questions);
        
        // Habilitar botón de enviar
        document.getElementById('submit-btn').disabled = false;

        // 5. Manejar envío del formulario
        document.getElementById('form-cuestionario').addEventListener('submit', (e) => {
          e.preventDefault();
          handleFormSubmit(e, supabaseClient, userId);
        });

      } catch (error) {
        console.error('Error inicial:', error);
        alert('Error al cargar la aplicación. Recarga la página.');
      }
    });

    // Función para cargar docentes
    async function loadTeachers(supabaseClient) {
      try {
        const { data, error } = await supabaseClient
          .from('User')
          .select('id, firstName, lastName')
          .eq('role', 'docente')
          .eq('active', true)
          .order('lastName', { ascending: true });
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Error cargando docentes:', error);
        return [];
      }
    }

    // Función para cargar preguntas
    async function loadQuestions(supabaseClient) {
      try {
        const { data, error } = await supabaseClient
          .from('Question')
          .select('id, text')
          .order('id', { ascending: true });
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Error cargando preguntas:', error);
        return [];
      }
    }

    // Renderizar lista de docentes
    function renderTeachers(teachers) {
      const select = document.getElementById('docente');
      select.innerHTML = '<option value="">-- Seleccione docente --</option>';
      
      if (teachers.length === 0) {
        select.innerHTML = '<option value="">No hay docentes disponibles</option>';
        return;
      }
      
      teachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = `${teacher.lastName}, ${teacher.firstName}`;
        select.appendChild(option);
      });
    }

    // Renderizar preguntas
    function renderQuestions(questions) {
      const container = document.getElementById('preguntas-container');
      container.innerHTML = '';
      
      if (questions.length === 0) {
        container.innerHTML = '<p>No hay preguntas disponibles</p>';
        return;
      }
      
      questions.forEach((question, index) => {
        const div = document.createElement('div');
        div.className = 'question';
        div.innerHTML = `
          <p>${index + 1}. ${question.text}</p>
          <div class="scale-options">
            <label><input type="radio" name="q${question.id}" value="1" required>1</label>
            <label><input type="radio" name="q${question.id}" value="2">2</label>
            <label><input type="radio" name="q${question.id}" value="3">3</label>
            <label><input type="radio" name="q${question.id}" value="4">4</label>
            <label><input type="radio" name="q${question.id}" value="5">5</label>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Manejar envío del formulario
    async function handleFormSubmit(event, supabaseClient, userId) {
      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const errorMsg = document.createElement('div');
      errorMsg.className = 'error';
      form.appendChild(errorMsg);
      
      try {
        // Deshabilitar botón durante el envío
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
        
        const formData = new FormData(form);
        const docenteId = formData.get('docente');
        const comentarios = formData.get('comentarios');
        
        // Validación básica
        if (!docenteId) {
          throw new Error('Debe seleccionar un docente');
        }

        // Obtener semestre actual (2025-1 o 2025-2)
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentSemester = now.getMonth() < 6 ? '1' : '2'; // Enero-Junio = 1, Julio-Dic = 2
        const semesterCode = `${currentYear}-${currentSemester}`;

        // 1. Crear o obtener semestre
        const semesterId = await getOrCreateSemester(supabaseClient, semesterCode, currentYear, currentSemester);
        
        // 2. Crear evaluación
        const { data: evaluation, error: evalError } = await supabaseClient
          .from('Evaluation')
          .insert([{
            userId: userId,
            teacherId: docenteId,
            semesterEvaluationId: semesterId,
            subjectId: 1, // Puedes cambiarlo según tu necesidad
            date: now.toISOString().split('T')[0],
            observations: comentarios,
            status: 'completed'
          }])
          .select()
          .single();

        if (evalError) throw evalError;

        // 3. Recoger respuestas
        const answers = [];
        formData.forEach((value, key) => {
          if (key.startsWith('q')) {
            const questionId = key.substring(1);
            answers.push({
              questionId: parseInt(questionId),
              evaluationId: evaluation.id,
              userId: userId,
              answer: value,
              score: parseInt(value),
              date: now.toISOString().split('T')[0]
            });
          }
        });

        // 4. Insertar respuestas
        const { error: ansError } = await supabaseClient
          .from('Answer')
          .insert(answers);

        if (ansError) throw ansError;

        // 5. Actualizar promedio
        await updateEvaluationAverage(supabaseClient, evaluation.id);

        // Éxito - redirigir
        window.location.href = 'gracias.html';

      } catch (error) {
        console.error('Error enviando evaluación:', error);
        errorMsg.textContent = error.message || 'Error al enviar la evaluación';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar';
      }
    }

    // Función auxiliar para manejar semestres
    async function getOrCreateSemester(supabaseClient, code, year, semester) {
      // Buscar si ya existe
      const { data: existing, error: searchError } = await supabaseClient
        .from('SemesterEvaluation')
        .select('id')
        .eq('code', code)
        .single();

      if (!searchError && existing) return existing.id;

      // Crear nuevo semestre
      const startDate = semester === '1' ? `${year}-01-01` : `${year}-07-01`;
      const endDate = semester === '1' ? `${year}-06-30` : `${year}-12-31`;

      const { data: newSemester, error: createError } = await supabaseClient
        .from('SemesterEvaluation')
        .insert([{
          code: code,
          startDate: startDate,
          endDate: endDate,
          description: `Evaluación ${semester === '1' ? 'Primer' : 'Segundo'} Semestre ${year}`
        }])
        .select()
        .single();

      if (createError) throw createError;
      return newSemester.id;
    }

    // Función auxiliar para actualizar promedio
    async function updateEvaluationAverage(supabaseClient, evalId) {
      const { error } = await supabaseClient
        .rpc('update_evaluation_average', { eval_id: evalId });
      
      if (error) throw error;
    }
  </script>
</body>
</html>