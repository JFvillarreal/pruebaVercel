<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Evaluación Docente</title>
  <link rel="stylesheet" href="css/cuestionario.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Tu contenido HTML existente -->
  <div class="header">
    <div class="title">
      <h1>Universidad El Bosque</h1>
      <h2>Evaluación docente</h2>
    </div>
    <img src="/img/logoUEB.png" alt="Logo Universidad" class="logo">
  </div>

  <form id="form-cuestionario" class="container">
    <!-- Mantener tu estructura de preguntas existente -->
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // 1. Verificar que Supabase está disponible
      if (typeof supabase === 'undefined') {
        console.error('Error: Supabase no se cargó correctamente');
        alert('Error inicializando la aplicación');
        window.location.href = 'index.html';
        return;
      }

      // 2. Inicializar Supabase (configuración IDÉNTICA a index.html)
      const supabaseUrl = 'https://crwjvwwaksvdnryjmzvl.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyd2p2d3dha3N2ZG5yeWptenZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3NDY3ODksImV4cCI6MjA2MDMyMjc4OX0.s08kYWtmpc9c2b9VGwcKuiEna48KGoK2vz4y8rafyrE';
      
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, {
        auth: {
          persistSession: true,
          storage: window.localStorage,
          autoRefreshToken: true,
          detectSessionInUrl: false
        }
      });

      // 3. Función de verificación de sesión mejorada
      async function verifySession() {
        try {
          // Verificar tokens manuales primero
          const accessToken = localStorage.getItem('sb-auth-token');
          if (!accessToken) throw new Error('No hay token de acceso');
          
          // Verificar sesión con Supabase
          const { data: { session }, error } = await supabaseClient.auth.getSession();
          if (error || !session) throw error || new Error('Sesión inválida');
          
          return true;
        } catch (error) {
          console.error('Error de verificación:', error);
          // Limpiar todo y redirigir
          localStorage.removeItem('sb-auth-token');
          localStorage.removeItem('sb-refresh-token');
          await supabaseClient.auth.signOut();
          window.location.href = 'index.html';
          return false;
        }
      }

      // 4. Cargar lista de docentes
      async function loadTeachers() {
        try {
          const { data: teachers, error } = await supabaseClient
            .from('User')
            .select('id, firstName, lastName')
            .eq('role', 'docente')
            .order('lastName', { ascending: true });

          if (error) throw error;

          const select = document.querySelector('select[name="docente"]');
          select.innerHTML = '<option value="">-- Seleccione --</option>';

          teachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = `${teacher.firstName} ${teacher.lastName}`;
            select.appendChild(option);
          });

        } catch (error) {
          console.error('Error cargando docentes:', error);
          alert('Error al cargar la lista de docentes');
        }
      }

      // 5. Manejar envío del formulario
      async function handleSubmit(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        
        try {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Enviando...';
          
          // Verificar sesión nuevamente antes de enviar
          if (!await verifySession()) return;

          // Resto de tu lógica de envío...
          
        } catch (error) {
          console.error('Error enviando evaluación:', error);
          alert(error.message || 'Error al enviar la evaluación');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enviar';
        }
      }

      // Inicialización principal
      try {
        if (!await verifySession()) return;
        await loadTeachers();
        document.getElementById('form-cuestionario').addEventListener('submit', handleSubmit);
      } catch (error) {
        console.error('Error inicial:', error);
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>