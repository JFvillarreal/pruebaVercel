<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Evaluación Docente</title>
  <link rel="stylesheet" href="css/cuestionario.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="header">
    <div class="title">
      <h1>Universidad El Bosque</h1>
      <h2>Evaluación docente</h2>
    </div>
    <img src="/img/logoUEB.png" alt="Logo Universidad El Bosque" class="logo">
  </div>

  <form id="form-cuestionario" class="container">
    <h3>Cuestionario de Evaluación Docente</h3>
    
    <!-- Selección de docente -->
    <div class="question">
      <p>Seleccione el docente evaluado:</p>
      <select id="docente" name="docente" required>
        <option value="">-- Cargando docentes --</option>
      </select>
    </div>
    
    <!-- Asignatura (si es necesaria) -->
    <div class="question" id="asignatura-container" style="display:none;">
      <p>Seleccione la asignatura:</p>
      <select id="asignatura" name="asignatura">
        <option value="">-- Seleccione --</option>
      </select>
    </div>
    
    <!-- Preguntas dinámicas -->
    <div id="preguntas-container"></div>
    
    <div class="question">
      <p>Comentarios adicionales (opcional):</p>
      <textarea name="comentarios" rows="4" placeholder="Escriba sus observaciones aquí..."></textarea>
    </div>
    
    <div class="navigation-buttons">
      <button type="submit">Enviar</button>
    </div>
  </form>

  <script>
    // Configuración de Supabase
    const supabaseUrl = 'https://crwjvwwaksvdnryjmzvl.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyd2p2d3dha3N2ZG5yeWptenZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3NDY3ODksImV4cCI6MjA2MDMyMjc4OX0.s08kYWtmpc9c2b9VGwcKuiEna48KGoK2vz4y8rafyrE';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Variables globales
    let userId = null;
    let currentSemester = '';
    let questions = [];

    // Función para determinar el semestre actual
    function getCurrentSemester() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1; // Enero es 0
      
      // Primer semestre: enero (1) a junio (6)
      // Segundo semestre: julio (7) a diciembre (12)
      const semester = month <= 6 ? '1' : '2';
      
      return `${year}-${semester}`;
    }

    // Cargar datos al iniciar
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Obtener usuario logueado
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = 'index.html';
          return;
        }
        userId = user.id;
        currentSemester = getCurrentSemester();

        // Cargar docentes (usuarios con rol 'docente')
        await loadTeachers();
        
        // Cargar preguntas
        const { data: preguntas, error } = await supabase
          .from('Question')
          .select('*')
          .order('id', { ascending: true });

        if (error) throw error;
        
        questions = preguntas;
        renderQuestions(preguntas);

      } catch (error) {
        console.error('Error al cargar datos:', error);
        alert('Error al cargar el cuestionario. Recarga la página.');
      }
    });

    // Cargar docentes desde la tabla User
    async function loadTeachers() {
      const selectDocente = document.getElementById('docente');
      
      try {
        const { data: teachers, error } = await supabase
          .from('User')
          .select('id, firstName, lastName')
          .eq('role', 'docente')
          .eq('active', true)
          .order('lastName', { ascending: true });

        if (error) throw error;

        // Limpiar y llenar el select
        selectDocente.innerHTML = '<option value="">-- Seleccione docente --</option>';
        
        teachers.forEach(teacher => {
          const option = document.createElement('option');
          option.value = teacher.id;
          option.textContent = `${teacher.lastName}, ${teacher.firstName}`;
          selectDocente.appendChild(option);
        });

      } catch (error) {
        console.error('Error al cargar docentes:', error);
        selectDocente.innerHTML = '<option value="">Error al cargar docentes</option>';
      }
    }

    // Renderizar preguntas (similar al anterior)
    function renderQuestions(preguntas) {
      const container = document.getElementById('preguntas-container');
      container.innerHTML = ''; // Limpiar contenedor
      
      preguntas.forEach((pregunta, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        
        questionDiv.innerHTML = `
          <p>${index + 1}. ${pregunta.text}</p>
          <div class="scale-options">
            <label><input type="radio" name="q${pregunta.id}" value="1" required>1</label>
            <label><input type="radio" name="q${pregunta.id}" value="2">2</label>
            <label><input type="radio" name="q${pregunta.id}" value="3">3</label>
            <label><input type="radio" name="q${pregunta.id}" value="4">4</label>
            <label><input type="radio" name="q${pregunta.id}" value="5">5</label>
          </div>
        `;
        
        container.appendChild(questionDiv);
      });
    }

    // Manejar envío del formulario
    document.getElementById('form-cuestionario').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const docenteId = formData.get('docente');
      const comentarios = formData.get('comentarios');

      try {
        // 1. Buscar o crear el semesterEvaluationId
        const semesterId = await getOrCreateSemesterEvaluation(currentSemester);
        
        // 2. Crear evaluación (sin subjectId por ahora)
        const { data: evaluation, error: evalError } = await supabase
          .from('Evaluation')
          .insert([
            { 
              userId: userId,
              teacherId: docenteId,
              semesterEvaluationId: semesterId,
              subjectId: 1, // Puedes obtenerlo de un select si es necesario
              date: new Date().toISOString().split('T')[0],
              observations: comentarios,
              status: 'completed'
            }
          ])
          .select()
          .single();

        if (evalError) throw evalError;

        // 3. Guardar respuestas
        const respuestas = [];
        for (const [name, value] of formData.entries()) {
          if (name.startsWith('q')) {
            const questionId = name.substring(1);
            respuestas.push({
              questionId: parseInt(questionId),
              evaluationId: evaluation.id,
              userId: userId,
              answer: value,
              score: parseInt(value),
              date: new Date().toISOString().split('T')[0]
            });
          }
        }

        const { error: ansError } = await supabase
          .from('Answer')
          .insert(respuestas);

        if (ansError) throw ansError;

        // 4. Actualizar promedio
        await updateEvaluationAverage(evaluation.id);

        alert('¡Evaluación enviada con éxito!');
        window.location.href = 'gracias.html';

      } catch (error) {
        console.error('Error al enviar evaluación:', error);
        alert('Ocurrió un error al enviar tus respuestas. Intenta nuevamente.');
      }
    });

    // Función para obtener o crear el semestre
    async function getOrCreateSemesterEvaluation(semesterCode) {
      // Primero buscamos si ya existe
      const { data: existing, error: searchError } = await supabase
        .from('SemesterEvaluation')
        .select('id')
        .eq('code', semesterCode)
        .single();

      if (!searchError && existing) return existing.id;

      // Si no existe, lo creamos
      const [year, sem] = semesterCode.split('-');
      const startDate = sem === '1' ? `${year}-01-01` : `${year}-07-01`;
      const endDate = sem === '1' ? `${year}-06-30` : `${year}-12-31`;

      const { data: newSemester, error: createError } = await supabase
        .from('SemesterEvaluation')
        .insert([
          {
            code: semesterCode,
            startDate: startDate,
            endDate: endDate,
            description: `Evaluación ${sem === '1' ? 'Primer' : 'Segundo'} Semestre ${year}`
          }
        ])
        .select()
        .single();

      if (createError) throw createError;
      return newSemester.id;
    }

    // Función para actualizar el promedio
    async function updateEvaluationAverage(evalId) {
      const { error } = await supabase
        .rpc('update_evaluation_average', { eval_id: evalId });

      if (error) throw error;
    }
  </script>
</body>
</html>